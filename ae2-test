local mon = peripheral.find("monitor")
local me = peripheral.find("me_bridge")

if not mon then error("Kein Monitor gefunden!") end
if not me then error("Keine ME-Bridge gefunden!") end

-- Funktion zum Formatieren groÃŸer Zahlen mit K, M, G
local function formatBytes(bytes)
    if bytes >= 1000000000 then
        return string.format("%.2fG", bytes / 1000000000)
    elseif bytes >= 1000000 then
        return string.format("%.2fM", bytes / 1000000)
    elseif bytes >= 1000 then
        return string.format("%.2fK", bytes / 1000)
    else
        return tostring(bytes)
    end
end

local function prepareMonitor()
    mon.clear()
    mon.setCursorPos(1,1)
    mon.setTextScale(1)
    mon.setBackgroundColor(colors.black)
    mon.setTextColor(colors.white)
    mon.write("AE2 Crafting CPU Dashboard")
end

local function clearMonitor()
    local w, h = mon.getSize()
    for y=2,h do
        mon.setCursorPos(1,y)
        mon.clearLine()
    end
end

local function displayCPUs()
    clearMonitor()
    local cpus = me.getCraftingCPUs()
    local y = 2

    if not cpus or #cpus == 0 then
        mon.setCursorPos(1,y)
        mon.write("Keine Crafting CPUs gefunden.")
        return
    end

    for i, cpu in ipairs(cpus) do
        -- Zeile 1: CPU Nummer
        mon.setCursorPos(1,y)
        mon.write("CPU " .. i)
        y = y + 1

        -- Zeile 2: Busy, Storage, CoProc
        mon.setCursorPos(1,y)
        mon.write(string.format("Busy: %s | Storage: %s | CoProc: %d",
            tostring(cpu.isBusy), formatBytes(cpu.storage), cpu.coProcessors
        ))
        y = y + 1

        -- Zeile 3: Job
        local jobText = "None"
        if cpu.craftingJob then
            jobText = string.format("ID:%s Item:%s Amt:%d Status:%s",
                cpu.craftingJob.id, cpu.craftingJob.item or "Unknown", cpu.craftingJob.amount or 0, cpu.craftingJob.status or "Unknown"
            )
        end
        mon.setCursorPos(1,y)
        mon.write("Job: " .. jobText)
        y = y + 1

        if y > select(2, mon.getSize()) then break end
    end
end

prepareMonitor()
while true do
    displayCPUs()
    sleep(2)
end
